<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>MICT SP Performance Analytics | Enhanced</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root {
      --pbi-header: #252423;
      --pbi-canvas: #f0f2f5;
      --pbi-card-bg: #ffffff;
      --pbi-accent: #0078d4;
      --pbi-text: #201f1e;
      --pbi-grid: #e1dfdd;
    }
    [data-theme="dark"] {
      --pbi-header: #1e1e1e;
      --pbi-canvas: #252423;
      --pbi-card-bg: #333333;
      --pbi-accent: #4da6ff;
      --pbi-text: #f3f2f1;
      --pbi-grid: #484644;
    }
    body {
      background-color: var(--pbi-canvas);
      color: var(--pbi-text);
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .pbi-top-bar {
      background-color: var(--pbi-header);
      color: white;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 1rem;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      flex-shrink: 0;
      z-index: 50;
    }
    .main-wrapper {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    .slicer-pane {
      width: 260px;
      background-color: var(--pbi-card-bg);
      border-right: 1px solid var(--pbi-grid);
      padding: 16px;
      overflow-y: auto;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      gap: 16px;
      transition: width 0.3s ease;
    }
    .canvas-area {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      position: relative;
    }
    .viz-card {
      background-color: var(--pbi-card-bg);
      border: 1px solid transparent;
      box-shadow: 0 1.6px 3.6px 0 rgba(0,0,0,0.132), 0 0.3px 0.9px 0 rgba(0,0,0,0.108);
      padding: 12px;
      height: 100%;
      display: flex;
      flex-direction: column;
      border-radius: 2px;
      transition: all 0.3s;
      position: relative;
    }
    .viz-card:hover {
      box-shadow: 0 3.2px 7.2px 0 rgba(0,0,0,0.132), 0 0.6px 1.8px 0 rgba(0,0,0,0.108);
    }
    .viz-header {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--pbi-text);
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 4px;
    }
    .tab-container {
      display: flex;
      gap: 24px;
      padding: 0 20px;
      background: var(--pbi-card-bg);
      border-bottom: 1px solid var(--pbi-grid);
      flex-shrink: 0;
    }
    .tab {
      padding: 12px 4px;
      cursor: pointer;
      font-weight: 400;
      color: #605e5c;
      font-size: 0.95rem;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
    }
    .tab.active {
      color: var(--pbi-text);
      font-weight: 600;
      border-bottom: 3px solid #e2a03f;
    }
    .kpi-value { font-size: 2.2rem; font-weight: 600; color: var(--pbi-text); }
    .kpi-label { font-size: 0.8rem; text-transform: uppercase; color: #605e5c; margin-bottom: 4px; letter-spacing: 0.5px; }
    .kpi-delta { font-size: 0.85rem; display: flex; align-items: center; gap: 4px; font-weight: 500; }
    .data-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    .data-table th { text-align: left; padding: 8px 8px; border-bottom: 2px solid var(--pbi-grid); color: #605e5c; font-weight: 600; position: sticky; top: 0; background: var(--pbi-card-bg); z-index: 10;}
    .data-table td { padding: 8px; border-bottom: 1px solid var(--pbi-grid); vertical-align: middle; }
    .data-table tr:hover { background-color: rgba(0,0,0,0.03); }
    .dark-mode .data-table tr:hover { background-color: rgba(255,255,255,0.05); }
    .pbi-select {
      width: 100%; padding: 6px; border: 1px solid #8a8886; border-radius: 2px;
      font-size: 0.9rem; background: var(--pbi-card-bg); color: var(--pbi-text);
    }
    .pbi-select:focus { border-color: var(--pbi-accent); outline: 1px solid var(--pbi-accent); }
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-thumb { background: #c8c6c4; border-radius: 4px; }
    .status-badge { padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 600; display: inline-block; min-width: 70px; text-align: center; }
    .badge-excellent { background: #e6f8e7; color: #107c10; }
    .badge-moderate { background: #fff4ce; color: #795e00; }
    .badge-risk { background: #fde7e9; color: #a80000; }
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.4); z-index: 2000; display: none;
      align-items: center; justify-content: center;
      backdrop-filter: blur(2px);
    }
    .modal-content {
      background: var(--pbi-card-bg); padding: 24px; border-radius: 2px; width: 450px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }
    .modal-content.large { width: 90%; max-width: 1100px; height: 85vh; padding: 0; display: flex; flex-direction: column; overflow: hidden; }
    .ai-chat-container {
      position: fixed; bottom: 0; right: 20px; width: 350px; height: 500px;
      background: var(--pbi-card-bg); border-radius: 8px 8px 0 0;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.15); display: none;
      flex-direction: column; z-index: 1001; border: 1px solid var(--pbi-grid);
    }
    .voice-active { animation: pulse 1.5s infinite; }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%; animation: loading 1.5s infinite;
    }
    @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
  </style>
</head>
<body>
  <!-- Hidden File Input -->
  <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="handleFileUpload(event)">

  <!-- Loading Overlay -->
  <div id="loadingIndicator" class="fixed inset-0 bg-white/80 dark:bg-black/80 flex items-center justify-center z-[9999] transition-opacity duration-500">
    <div class="flex flex-col items-center">
      <div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-4"></div>
      <div class="text-xl font-semibold text-gray-700 dark:text-gray-200">Hydrating Data Model...</div>
    </div>
  </div>

  <!-- Navbar -->
  <div class="pbi-top-bar">
    <div class="flex items-center gap-3">
      <div class="bg-yellow-500 p-1.5 rounded-sm">
        <i data-feather="bar-chart-2" class="w-4 h-4 text-black"></i>
      </div>
      <span class="font-semibold tracking-wide text-sm">MICT SP Performance Analytics</span>
      <span class="text-xs bg-gray-700 px-2 py-0.5 rounded ml-2" id="dsName">Master_Dataset_v3.0.json</span>
    </div>
    
    <div class="flex items-center gap-4">
       <div id="voiceStatus" class="hidden flex items-center gap-2 bg-red-600 px-2 py-1 rounded text-xs font-bold animate-pulse">
          <i data-feather="mic" class="w-3 h-3"></i> Listening...
       </div>

       <div class="flex items-center gap-1">
          <button onclick="toggleLiveMode()" id="liveBtn" class="px-3 py-1 text-xs hover:bg-white/10 rounded transition flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-gray-400" id="liveDot"></span> Live
          </button>
       </div>

       <div class="h-4 w-px bg-white/30"></div>

       <div class="flex gap-2">
         <button onclick="document.getElementById('fileInput').click()" title="Import Data" class="p-1.5 hover:bg-white/10 rounded"><i data-feather="upload-cloud" class="w-4 h-4"></i></button>
         <button onclick="openExportModal()" title="Export" class="p-1.5 hover:bg-white/10 rounded"><i data-feather="download" class="w-4 h-4"></i></button>
         <button onclick="openSettingsModal()" title="Settings" class="p-1.5 hover:bg-white/10 rounded"><i data-feather="settings" class="w-4 h-4"></i></button>
         <button onclick="toggleAIChat()" title="AI Assistant" class="p-1.5 hover:bg-white/10 rounded relative">
            <i data-feather="message-square" class="w-4 h-4"></i>
            <span class="absolute top-1 right-1 w-2 h-2 bg-yellow-400 rounded-full"></span>
         </button>
         <button onclick="toggleVoiceControl()" title="Voice Control" class="p-1.5 hover:bg-white/10 rounded voice-active"><i data-feather="mic" class="w-4 h-4"></i></button>
       </div>

       <div class="h-4 w-px bg-white/30"></div>
       
       <label class="cursor-pointer">
          <input type="checkbox" id="darkModeToggle" class="hidden">
          <i data-feather="moon" class="w-4 h-4 text-gray-300 hover:text-white transition"></i>
       </label>
    </div>
  </div>

  <!-- Tab Navigation -->
  <div class="tab-container">
    <div class="tab active" onclick="switchTab('overview', this)">Executive Overview</div>
    <div class="tab" onclick="switchTab('kanban', this)">Pipeline & Workflow</div>
    <div class="tab" onclick="switchTab('analytics', this)">Deep Dive Analytics</div>
    <div class="tab" onclick="switchTab('candidates', this)">Candidate Management</div>
  </div>

  <!-- Alerts Container -->
  <div id="performanceAlerts" class="fixed top-16 right-5 z-[2000] w-80 space-y-2 pointer-events-none"></div>

  <!-- Main Content Wrapper -->
  <div class="main-wrapper">
    
    <!-- Slicer Pane (Left Sidebar) -->
    <div class="slicer-pane custom-scrollbar" id="slicerPane">
        <div class="flex justify-between items-center mb-2">
            <span class="text-sm font-bold uppercase text-gray-500">Filters</span>
            <button class="text-xs text-blue-600 hover:underline" onclick="resetDashboard()">Reset All</button>
        </div>

        <div class="mb-2">
            <div class="relative">
                <input id="searchIn" type="text" class="pbi-select pl-8" placeholder="Search Candidate...">
                <i data-feather="search" class="w-4 h-4 absolute left-2 top-2 text-gray-400"></i>
            </div>
        </div>

        <div class="bg-gray-50 dark:bg-white/5 p-2 rounded border border-gray-200 dark:border-gray-700">
            <label class="text-xs font-semibold mb-1 block">Development Group</label>
            <select id="groupSel" class="pbi-select h-24" multiple>
                <option value="All" selected>Select All</option>
            </select>
            <div class="text-[10px] text-gray-400 mt-1 italic">Ctrl+Click to select multiple</div>
        </div>

        <div>
            <label class="text-xs font-semibold mb-1 block">Sprint Timeline</label>
            <select id="weekSel" class="pbi-select">
                <option value="All">All Weeks</option>
            </select>
        </div>

        <div>
            <label class="text-xs font-semibold mb-2 block">Performance Status</label>
            <div class="space-y-1">
                <label class="flex items-center gap-2 cursor-pointer p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">
                    <input type="checkbox" class="status-chk accent-green-600" value="Excellent" checked> 
                    <span class="w-3 h-3 rounded-full bg-green-500"></span>
                    <span class="text-xs">Excellent (>80%)</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">
                    <input type="checkbox" class="status-chk accent-yellow-600" value="Moderate" checked>
                    <span class="w-3 h-3 rounded-full bg-yellow-500"></span> 
                    <span class="text-xs">Moderate (60-80%)</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">
                    <input type="checkbox" class="status-chk accent-red-600" value="At-risk" checked> 
                    <span class="w-3 h-3 rounded-full bg-red-500"></span>
                    <span class="text-xs">At Risk (<60%)</span>
                </label>
            </div>
        </div>

        <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
             <div class="flex justify-between text-xs mb-1 font-semibold">
                 <span>Min Score</span>
                 <span id="scoreVal" class="text-blue-600">0%</span>
             </div>
             <input type="range" id="minScore" min="0" max="100" value="0" class="w-full h-1 bg-gray-300 rounded-lg appearance-none cursor-pointer accent-blue-600">
        </div>

        <div class="mt-auto bg-yellow-50 dark:bg-yellow-900/20 border-l-4 border-yellow-400 p-3 rounded text-xs shadow-sm">
            <div class="font-bold text-yellow-800 dark:text-yellow-200 flex items-center gap-1 mb-2">
                <i data-feather="zap" class="w-3 h-3"></i> AI Smart Insight
            </div>
            <div id="aiInsights" class="leading-relaxed opacity-90">Analyzing dataset...</div>
        </div>
    </div>

    <!-- Canvas (Main Report Area) -->
    <div class="canvas-area custom-scrollbar bg-gray-100 dark:bg-[#201f1e]">
        
        <!-- OVERVIEW TAB -->
        <div id="overviewTab" class="tab-content block h-full">
            <div class="grid grid-cols-12 gap-4 h-full">
                
                <!-- KPIs -->
                <div class="col-span-12 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 h-[120px]">
                    <div class="viz-card border-l-4 border-blue-500 justify-center">
                        <div class="kpi-label">Avg Cohort Score</div>
                        <div class="kpi-value" id="kpiAvg">0%</div>
                        <div class="kpi-delta text-green-600"><i data-feather="trending-up" class="w-3 h-3"></i> vs prev week</div>
                    </div>
                    <div class="col-span-1 viz-card border-l-4 border-red-500 justify-center">
                        <div class="kpi-label">At-Risk Candidates</div>
                        <div class="kpi-value text-red-600" id="kpiRisk">0</div>
                        <div class="kpi-delta text-gray-400">Requires Intervention</div>
                    </div>
                    <div class="col-span-1 viz-card border-l-4 border-green-500 justify-center">
                        <div class="kpi-label">Avg Attendance</div>
                        <div class="kpi-value" id="kpiAtt">0.0</div>
                        <div class="kpi-delta text-gray-400">Max: 5.0</div>
                    </div>
                    <div class="col-span-1 viz-card border-l-4 border-purple-500 justify-center">
                        <div class="kpi-label">Top Performer</div>
                        <div class="text-xl font-bold mt-1 truncate" id="kpiTopName">-</div>
                        <div class="text-sm text-purple-600 font-semibold" id="kpiTopScore">-</div>
                    </div>
                </div>

                <!-- Charts Row 1 -->
                <div class="col-span-12 lg:col-span-8 viz-card min-h-[300px]">
                    <div class="viz-header">
                        <span>Performance Trend by Group</span>
                    </div>
                    <div id="trendChart" class="w-full flex-1"></div>
                </div>

                <div class="col-span-12 lg:col-span-4 viz-card min-h-[300px]">
                     <div class="viz-header">Status Distribution</div>
                     <div id="distChart" class="w-full flex-1"></div>
                </div>

                <!-- Charts Row 2 -->
                <div class="col-span-12 lg:col-span-6 viz-card min-h-[300px]">
                    <div class="viz-header">Tech vs. Soft Skills Correlation</div>
                    <div id="scatterChart" class="w-full flex-1"></div>
                </div>

                <div class="col-span-12 lg:col-span-6 viz-card min-h-[300px]">
                    <div class="viz-header">Cohort Skill Profile (Radar)</div>
                    <div id="radarChart" class="w-full flex-1"></div>
                </div>

                <!-- Matrix Table -->
                <div class="col-span-12 viz-card min-h-[400px]">
                    <div class="viz-header">
                        <div class="flex items-center gap-2">
                             <span>Detailed Candidate Matrix</span>
                             <span class="text-xs font-normal text-gray-500 bg-gray-100 dark:bg-gray-700 px-2 py-0.5 rounded" id="tableCount">0 rows</span>
                        </div>
                        <div class="flex gap-2">
                             <button id="compareBtn" onclick="compareCandidates()" class="hidden text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded font-bold hover:bg-blue-200">Compare Selected</button>
                        </div>
                    </div>
                    <div class="overflow-auto custom-scrollbar flex-1 relative">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th width="30"><input type="checkbox" id="selectAll"></th>
                                    <th>Candidate Name</th>
                                    <th>Group</th>
                                    <th>Week</th>
                                    <th>Attendance</th>
                                    <th>Tech Score</th>
                                    <th>Overall Score</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="candidateTableBody"></tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>

        <!-- KANBAN TAB -->
        <div id="kanbanTab" class="tab-content hidden h-full">
            <div class="flex gap-4 h-full overflow-x-auto pb-2">
                <div class="flex-1 min-w-[280px] bg-gray-200 dark:bg-white/5 rounded p-3 flex flex-col" ondragover="allowDrop(event)" ondrop="drop(event, 'Training')">
                    <div class="font-bold text-gray-600 dark:text-gray-300 mb-3 flex justify-between">
                        <span>IN TRAINING</span>
                        <span class="bg-gray-300 dark:bg-gray-600 px-2 rounded-full text-xs flex items-center" id="cntTraining">0</span>
                    </div>
                    <div class="flex-1 overflow-y-auto space-y-2 custom-scrollbar" id="colTraining"></div>
                </div>
                
                <div class="flex-1 min-w-[280px] bg-blue-50 dark:bg-blue-900/10 rounded p-3 flex flex-col border-t-4 border-blue-500" ondragover="allowDrop(event)" ondrop="drop(event, 'Interview Ready')">
                     <div class="font-bold text-blue-800 dark:text-blue-300 mb-3 flex justify-between">
                        <span>INTERVIEW READY</span>
                        <span class="bg-blue-200 dark:bg-blue-800 px-2 rounded-full text-xs flex items-center" id="cntInterview">0</span>
                    </div>
                    <div class="flex-1 overflow-y-auto space-y-2 custom-scrollbar" id="colInterview"></div>
                </div>

                 <div class="flex-1 min-w-[280px] bg-green-50 dark:bg-green-900/10 rounded p-3 flex flex-col border-t-4 border-green-500" ondragover="allowDrop(event)" ondrop="drop(event, 'Placed')">
                     <div class="font-bold text-green-800 dark:text-green-300 mb-3 flex justify-between">
                        <span>PLACED</span>
                        <span class="bg-green-200 dark:bg-green-800 px-2 rounded-full text-xs flex items-center" id="cntPlaced">0</span>
                    </div>
                    <div class="flex-1 overflow-y-auto space-y-2 custom-scrollbar" id="colPlaced"></div>
                </div>

                <div class="flex-1 min-w-[280px] bg-red-50 dark:bg-red-900/10 rounded p-3 flex flex-col border-t-4 border-red-500" ondragover="allowDrop(event)" ondrop="drop(event, 'Needs Support')">
                     <div class="font-bold text-red-800 dark:text-red-300 mb-3 flex justify-between">
                        <span>NEEDS SUPPORT</span>
                        <span class="bg-red-200 dark:bg-red-800 px-2 rounded-full text-xs flex items-center" id="cntSupport">0</span>
                    </div>
                    <div class="flex-1 overflow-y-auto space-y-2 custom-scrollbar" id="colSupport"></div>
                </div>
            </div>
        </div>

        <!-- ANALYTICS TAB -->
        <div id="analyticsTab" class="tab-content hidden h-full">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 h-full overflow-y-auto custom-scrollbar pr-2 pb-4">
                <div class="viz-card min-h-[300px]">
                   <div class="viz-header">Group Performance Comparison</div>
                   <div id="groupPerfChart" class="w-full flex-1"></div>
                </div>
                <div class="viz-card min-h-[300px]">
                   <div class="viz-header">Skill Profile by Performance Category</div>
                   <div id="skillDistChart" class="w-full flex-1"></div>
                </div>
                <div class="viz-card min-h-[350px]">
                   <div class="viz-header">Performance Distribution by Group (Box Plot)</div>
                   <div id="distBoxChart" class="w-full flex-1"></div>
                </div>
                <div class="viz-card min-h-[350px]">
                   <div class="viz-header">Metric Correlation Matrix</div>
                   <div id="corrHeatmap" class="w-full flex-1"></div>
                </div>
                <div class="viz-card min-h-[300px]">
                   <div class="viz-header">Peer Comparison Scatter</div>
                   <div id="peerChart" class="w-full flex-1"></div>
                </div>
                <div class="viz-card min-h-[300px]">
                   <div class="viz-header">Retention Risk Matrix</div>
                   <div id="riskChart" class="w-full flex-1"></div>
                </div>
             </div>
        </div>

        <!-- CANDIDATES TAB -->
        <div id="candidatesTab" class="tab-content hidden h-full">
             <div class="grid grid-cols-3 gap-6 h-full">
                <div class="col-span-2 viz-card">
                    <div class="viz-header border-b border-gray-100 pb-2 mb-2">
                        <span>Active Development Plans</span>
                        <button class="bg-blue-600 text-white px-3 py-1 text-xs rounded hover:bg-blue-700">+ Create Plan</button>
                    </div>
                    <div id="devPlansContainer" class="space-y-3 overflow-y-auto pr-2">
                        <!-- JS -->
                    </div>
                </div>
                <div class="viz-card h-fit">
                    <div class="viz-header">Quick Actions</div>
                    <div class="grid grid-cols-1 gap-3">
                         <button class="flex items-center gap-3 p-3 border rounded hover:bg-gray-50 dark:hover:bg-white/5 text-left group">
                             <div class="bg-blue-100 dark:bg-blue-900 text-blue-600 p-2 rounded group-hover:bg-blue-600 group-hover:text-white transition"><i data-feather="calendar" class="w-4 h-4"></i></div>
                             <div>
                                 <div class="text-sm font-bold">Schedule Review</div>
                                 <div class="text-xs text-gray-500">Book 1:1 sessions</div>
                             </div>
                         </button>
                         <button class="flex items-center gap-3 p-3 border rounded hover:bg-gray-50 dark:hover:bg-white/5 text-left group">
                             <div class="bg-purple-100 dark:bg-purple-900 text-purple-600 p-2 rounded group-hover:bg-purple-600 group-hover:text-white transition"><i data-feather="mail" class="w-4 h-4"></i></div>
                             <div>
                                 <div class="text-sm font-bold">Bulk Email</div>
                                 <div class="text-xs text-gray-500">Send status reports</div>
                             </div>
                         </button>
                    </div>
                </div>
             </div>
        </div>

    </div>
  </div>

  <!-- Candidate Details Modal (Large) -->
  <div id="candidateModal" class="modal-overlay" onclick="if(event.target===this) closeCandidateModal()">
    <div class="modal-content large bg-gray-50 dark:bg-[#201f1e]">
       <div class="bg-white dark:bg-[#252423] p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center sticky top-0 z-20">
            <div class="flex items-center gap-4">
                <div class="h-12 w-12 rounded bg-blue-600 text-white flex items-center justify-center font-bold text-xl shadow-lg" id="modalInitials">JD</div>
                <div>
                    <h2 class="text-xl font-bold" id="modalName">John Doe</h2>
                    <div class="text-sm text-gray-500 flex gap-2 items-center">
                        <span id="modalGroup">Scan-Tech</span>
                        <span class="w-1 h-1 bg-gray-400 rounded-full"></span>
                        <span id="modalBadge" class="status-badge">Excellent</span>
                    </div>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="generateSinglePDF()" class="px-4 py-2 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 rounded text-sm font-semibold flex items-center gap-2">
                    <i data-feather="printer" class="w-4 h-4"></i> Report
                </button>
                <button onclick="closeCandidateModal()" class="p-2 hover:bg-red-50 hover:text-red-600 rounded"><i data-feather="x" class="w-5 h-5"></i></button>
            </div>
       </div>

       <div class="p-6 overflow-y-auto bg-gray-50 dark:bg-[#1b1b1b] flex-1">
            <!-- Metric Cards -->
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                <div class="bg-white dark:bg-[#252423] p-4 rounded shadow-sm border-t-4 border-blue-500">
                    <div class="text-xs text-gray-500 uppercase">Overall</div>
                    <div class="text-2xl font-bold mt-1" id="modalScore">0%</div>
                </div>
                <div class="bg-white dark:bg-[#252423] p-4 rounded shadow-sm border-t-4 border-green-500">
                    <div class="text-xs text-gray-500 uppercase">Attendance</div>
                    <div class="text-2xl font-bold mt-1" id="modalAtt">0</div>
                </div>
                <div class="bg-white dark:bg-[#252423] p-4 rounded shadow-sm border-t-4 border-purple-500">
                    <div class="text-xs text-gray-500 uppercase">Tech Skills</div>
                    <div class="text-2xl font-bold mt-1" id="modalTech">0</div>
                </div>
                <div class="bg-white dark:bg-[#252423] p-4 rounded shadow-sm border-t-4 border-orange-500">
                    <div class="text-xs text-gray-500 uppercase">Projects</div>
                    <div class="text-2xl font-bold mt-1" id="modalProj">0</div>
                </div>
                <div class="bg-white dark:bg-[#252423] p-4 rounded shadow-sm border-t-4 border-teal-500">
                    <div class="text-xs text-gray-500 uppercase">Soft Skills</div>
                    <div class="text-2xl font-bold mt-1" id="modalSoft">0</div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                 <div class="viz-card h-[350px]">
                     <div class="viz-header">Performance Trajectory</div>
                     <div id="modalTrendChart" class="w-full h-full"></div>
                 </div>
                 <div class="viz-card h-[350px]">
                     <div class="viz-header">Detailed Skill Profile</div>
                     <div id="modalRadarChart" class="w-full h-full"></div>
                 </div>
            </div>

            <div class="mt-6 bg-blue-50 dark:bg-blue-900/10 p-4 rounded border border-blue-100 dark:border-blue-800">
                <h3 class="font-bold text-blue-800 dark:text-blue-300 mb-2 flex items-center gap-2"><i data-feather="info" class="w-4 h-4"></i> Automated Recommendations</h3>
                <ul class="list-disc ml-5 text-sm space-y-1 text-gray-700 dark:text-gray-300" id="modalRecs"></ul>
            </div>
       </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="modal-overlay" onclick="if(event.target===this) document.getElementById('settingsModal').style.display='none'">
     <div class="modal-content">
         <h3 class="text-lg font-bold mb-4 border-b pb-2">Configuration</h3>
         <div class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
             <h4 class="text-xs font-bold uppercase text-gray-500">Weighted Scoring Model</h4>
             <div class="grid grid-cols-2 gap-3 text-sm">
                 <div><label>Attendance Weight</label><input type="number" id="w_Att" class="pbi-select" value="1"></div>
                 <div><label>Tech Skill Weight</label><input type="number" id="w_Tech" class="pbi-select" value="1"></div>
                 <div><label>Communication</label><input type="number" id="w_Comm" class="pbi-select" value="1"></div>
                 <div><label>Project Delivery</label><input type="number" id="w_Proj" class="pbi-select" value="1"></div>
                 <div><label>Code Quality</label><input type="number" id="w_Code" class="pbi-select" value="1"></div>
                 <div><label>Problem Solving</label><input type="number" id="w_Prob" class="pbi-select" value="1"></div>
             </div>
         </div>
         <div class="flex gap-2 mt-6">
             <button onclick="saveSettings()" class="flex-1 bg-blue-600 text-white py-2 rounded text-sm font-semibold hover:bg-blue-700">Apply Changes</button>
         </div>
     </div>
  </div>

  <!-- AI Chat Widget -->
  <div id="aiChat" class="ai-chat-container">
    <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-3 flex justify-between items-center cursor-pointer rounded-t-lg" onclick="toggleAIChat()">
        <span class="font-bold text-sm flex items-center gap-2"><i data-feather="cpu" class="w-4 h-4"></i> MICT AI Analyst</span>
        <i data-feather="chevron-down" class="w-4 h-4"></i>
    </div>
    <div class="flex-1 p-4 overflow-y-auto bg-gray-50 dark:bg-[#1b1b1b]" id="chatHistory">
        <div class="bg-white dark:bg-[#333] p-3 rounded-tr-lg rounded-br-lg rounded-bl-lg shadow-sm text-sm border border-gray-100 dark:border-gray-600 mb-3">
            Hello! I'm analyzing the <b>Full Cohort History</b>. I can filter data, switch themes, or find specific candidates. Try asking:
            <div class="mt-2 flex flex-wrap gap-2">
                <span class="bg-blue-100 text-blue-700 px-2 py-1 rounded-full text-xs cursor-pointer hover:bg-blue-200" onclick="askAI('Top performers')">üèÜ Top 3</span>
                <span class="bg-red-100 text-red-700 px-2 py-1 rounded-full text-xs cursor-pointer hover:bg-red-200" onclick="askAI('At risk candidates')">‚ö†Ô∏è At Risk</span>
                <span class="bg-purple-100 text-purple-700 px-2 py-1 rounded-full text-xs cursor-pointer hover:bg-purple-200" onclick="askAI('Reset filters')">üîÑ Reset</span>
            </div>
        </div>
    </div>
    <div class="p-3 bg-white dark:bg-[#252423] border-t border-gray-200 dark:border-gray-600 flex gap-2">
        <input type="text" id="chatInput" class="flex-1 text-sm border rounded-full px-3 outline-none focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600" placeholder="Ask me anything..." onkeypress="handleChatKey(event)">
        <button onclick="sendChat()" class="bg-blue-600 text-white rounded-full p-2 hover:bg-blue-700 transition"><i data-feather="send" class="w-4 h-4"></i></button>
    </div>
  </div>

  <script>
    const { jsPDF } = window.jspdf;

    // --- DATA & CONFIG ---
    const GROUPS = ['Scan-Tech', 'PinCoders', 'HTML Pioneers', 'A-Green Culture'];
    const WEEKS = ['Week 1', 'Week 2', 'Week 3', 'Week 4'];
    
    let scoringWeights = {
       Attendance: 1, TechSkills: 1, Communication: 1, Accountability: 1,
       CreativityOwnership: 1, ProjectDelivery: 1, ProblemSolving: 1, 
       Teamwork: 1, CodeQuality: 1, Leadership: 1
    };

    // --- RESTORED COMPLETE DATASET ---
    let ALL_DATA = [
      // SCAN-TECH GROUP
      {Week: "Week 1", Candidate:"Aldo Stevens", DevGroup:"Scan-Tech", Attendance:3, Communication:3, Accountability:3, CreativityOwnership:2, ProjectDelivery:2, TechSkills:2},
      {Week: "Week 2", Candidate:"Aldo Stevens", DevGroup:"Scan-Tech", Attendance:5, Communication:4, Accountability:4, CreativityOwnership:3, ProjectDelivery:3, TechSkills:3},
      {Week: "Week 3", Candidate:"Aldo Stevens", DevGroup:"Scan-Tech", Attendance:5, Communication:4, Accountability:4, CreativityOwnership:5, ProjectDelivery:3, TechSkills:4},
      {Week: "Week 4", Candidate:"Aldo Stevens", DevGroup:"Scan-Tech", Attendance:5, Communication:5, Accountability:3, CreativityOwnership:4, ProjectDelivery:4, TechSkills:4},
      
      {Week: "Week 1", Candidate:"Charlton Steenkamp", DevGroup:"Scan-Tech", Attendance:3, Communication:3, Accountability:3, CreativityOwnership:3, ProjectDelivery:3, TechSkills:3},
      {Week: "Week 2", Candidate:"Charlton Steenkamp", DevGroup:"Scan-Tech", Attendance:5, Communication:3, Accountability:4, CreativityOwnership:4, ProjectDelivery:3, TechSkills:3},
      {Week: "Week 3", Candidate:"Charlton Steenkamp", DevGroup:"Scan-Tech", Attendance:5, Communication:4, Accountability:4, CreativityOwnership:3, ProjectDelivery:3, TechSkills:3},
      {Week: "Week 4", Candidate:"Charlton Steenkamp", DevGroup:"Scan-Tech", Attendance:5, Communication:4, Accountability:5, CreativityOwnership:4, ProjectDelivery:4, TechSkills:4},
      
      {Week: "Week 1", Candidate:"Olona Mqongwana", DevGroup:"Scan-Tech", Attendance:5, Communication:3, Accountability:3, CreativityOwnership:4, ProjectDelivery:4, TechSkills:3},
      {Week: "Week 2", Candidate:"Olona Mqongwana", DevGroup:"Scan-Tech", Attendance:4, Communication:4, Accountability:4, CreativityOwnership:4, ProjectDelivery:4, TechSkills:3},
      {Week: "Week 3", Candidate:"Olona Mqongwana", DevGroup:"Scan-Tech", Attendance:4, Communication:4, Accountability:4, CreativityOwnership:4, ProjectDelivery:3, TechSkills:3},
      {Week: "Week 4", Candidate:"Olona Mqongwana", DevGroup:"Scan-Tech", Attendance:5, Communication:5, Accountability:2, CreativityOwnership:5, ProjectDelivery:5, TechSkills:4},
      
      {Week: "Week 1", Candidate:"Nontobeko Nkomo", DevGroup:"Scan-Tech", Attendance:2, Communication:3, Accountability:3, CreativityOwnership:2, ProjectDelivery:2, TechSkills:2},
      {Week: "Week 2", Candidate:"Nontobeko Nkomo", DevGroup:"Scan-Tech", Attendance:1, Communication:3, Accountability:3, CreativityOwnership:3, ProjectDelivery:2, TechSkills:3},
      {Week: "Week 3", Candidate:"Nontobeko Nkomo", DevGroup:"Scan-Tech", Attendance:2, Communication:3, Accountability:2, CreativityOwnership:2, ProjectDelivery:1, TechSkills:2},
      {Week: "Week 4", Candidate:"Nontobeko Nkomo", DevGroup:"Scan-Tech", Attendance:2, Communication:2, Accountability:2, CreativityOwnership:1, ProjectDelivery:1, TechSkills:1},
      
      {Week: "Week 1", Candidate:"Siyanda Dube", DevGroup:"Scan-Tech", Attendance:5, Communication:3, Accountability:3, CreativityOwnership:3, ProjectDelivery:1, TechSkills:4},
      {Week: "Week 2", Candidate:"Siyanda Dube", DevGroup:"Scan-Tech", Attendance:5, Communication:3, Accountability:3, CreativityOwnership:4, ProjectDelivery:3, TechSkills:4},
      {Week: "Week 3", Candidate:"Siyanda Dube", DevGroup:"Scan-Tech", Attendance:5, Communication:4, Accountability:4, CreativityOwnership:4, ProjectDelivery:4, TechSkills:5},
      {Week: "Week 4", Candidate:"Siyanda Dube", DevGroup:"Scan-Tech", Attendance:5, Communication:4, Accountability:5, CreativityOwnership:4, ProjectDelivery:5, TechSkills:5},

      // PINCODERS GROUP
      {Week: "Week 1", Candidate:"Anele Ngcatshe", DevGroup:"PinCoders", Attendance:4, Communication:3, Accountability:3, CreativityOwnership:3, ProjectDelivery:3, TechSkills:3},
      {Week: "Week 2", Candidate:"Anele Ngcatshe", DevGroup:"PinCoders", Attendance:4, Communication:3, Accountability:3, CreativityOwnership:2, ProjectDelivery:2, TechSkills:3},
      {Week: "Week 3", Candidate:"Anele Ngcatshe", DevGroup:"PinCoders", Attendance:3, Communication:3, Accountability:3, CreativityOwnership:2, ProjectDelivery:2, TechSkills:2},
      {Week: "Week 4", Candidate:"Anele Ngcatshe", DevGroup:"PinCoders", Attendance:4, Communication:4, Accountability:3, CreativityOwnership:3, ProjectDelivery:3, TechSkills:3},

      {Week: "Week 1", Candidate:"Ceshia Williams", DevGroup:"PinCoders", Attendance:3, Communication:3, Accountability:3, CreativityOwnership:2, ProjectDelivery:2, TechSkills:2},
      {Week: "Week 2", Candidate:"Ceshia Williams", DevGroup:"PinCoders", Attendance:3, Communication:3, Accountability:3, CreativityOwnership:2, ProjectDelivery:2, TechSkills:2},
      {Week: "Week 3", Candidate:"Ceshia Williams", DevGroup:"PinCoders", Attendance:4, Communication:3, Accountability:3, CreativityOwnership:2, ProjectDelivery:2, TechSkills:1},
      {Week: "Week 4", Candidate:"Ceshia Williams", DevGroup:"PinCoders", Attendance:4, Communication:3, Accountability:3, CreativityOwnership:3, ProjectDelivery:2, TechSkills:2},

      {Week: "Week 1", Candidate:"Lwazi Nhleko", DevGroup:"PinCoders", Attendance:3, Communication:3, Accountability:3, CreativityOwnership:2, ProjectDelivery:2, TechSkills:2},
      {Week: "Week 2", Candidate:"Lwazi Nhleko", DevGroup:"PinCoders", Attendance:4, Communication:3, Accountability:3, CreativityOwnership:3, ProjectDelivery:3, TechSkills:3},
      {Week: "Week 3", Candidate:"Lwazi Nhleko", DevGroup:"PinCoders", Attendance:5, Communication:4, Accountability:4, CreativityOwnership:3, ProjectDelivery:3, TechSkills:3},
      {Week: "Week 4", Candidate:"Lwazi Nhleko", DevGroup:"PinCoders", Attendance:5, Communication:4, Accountability:4, CreativityOwnership:4, ProjectDelivery:4, TechSkills:4},

      {Week: "Week 1", Candidate:"Thando Valley", DevGroup:"PinCoders", Attendance:4, Communication:3, Accountability:3, CreativityOwnership:3, ProjectDelivery:4, TechSkills:4},
      {Week: "Week 2", Candidate:"Thando Valley", DevGroup:"PinCoders", Attendance:5, Communication:4, Accountability:4, CreativityOwnership:4, ProjectDelivery:5, TechSkills:5},
      {Week: "Week 3", Candidate:"Thando Valley", DevGroup:"PinCoders", Attendance:5, Communication:5, Accountability:5, CreativityOwnership:5, ProjectDelivery:5, TechSkills:5},
      {Week: "Week 4", Candidate:"Thando Valley", DevGroup:"PinCoders", Attendance:5, Communication:5, Accountability:5, CreativityOwnership:5, ProjectDelivery:5, TechSkills:5},

      {Week: "Week 1", Candidate:"Zanele Gulwa", DevGroup:"PinCoders", Attendance:3, Communication:3, Accountability:3, CreativityOwnership:2, ProjectDelivery:1, TechSkills:3},
      {Week: "Week 2", Candidate:"Zanele Gulwa", DevGroup:"PinCoders", Attendance:3, Communication:3, Accountability:3, CreativityOwnership:2, ProjectDelivery:1, TechSkills:3},
      {Week: "Week 3", Candidate:"Zanele Gulwa", DevGroup:"PinCoders", Attendance:2, Communication:2, Accountability:2, CreativityOwnership:2, ProjectDelivery:1, TechSkills:2},
      {Week: "Week 4", Candidate:"Zanele Gulwa", DevGroup:"PinCoders", Attendance:3, Communication:3, Accountability:3, CreativityOwnership:2, ProjectDelivery:2, TechSkills:2},

      // HTML PIONEERS GROUP
      {Week: "Week 1", Candidate:"Aphiwe Tyhalisi", DevGroup:"HTML Pioneers", Attendance:3, Communication:3, Accountability:3, CreativityOwnership:3, ProjectDelivery:4, TechSkills:4},
      {Week: "Week 2", Candidate:"Aphiwe Tyhalisi", DevGroup:"HTML Pioneers", Attendance:5, Communication:4, Accountability:4, CreativityOwnership:4, ProjectDelivery:4, TechSkills:4},
      {Week: "Week 3", Candidate:"Aphiwe Tyhalisi", DevGroup:"HTML Pioneers", Attendance:5, Communication:4, Accountability:4, CreativityOwnership:4, ProjectDelivery:5, TechSkills:4},
      {Week: "Week 4", Candidate:"Aphiwe Tyhalisi", DevGroup:"HTML Pioneers", Attendance:5, Communication:5, Accountability:5, CreativityOwnership:4, ProjectDelivery:5, TechSkills:5},

      {Week: "Week 1", Candidate:"Ashura Noordien", DevGroup:"HTML Pioneers", Attendance:5, Communication:2, Accountability:3, CreativityOwnership:2, ProjectDelivery:2, TechSkills:2},
      {Week: "Week 2", Candidate:"Ashura Noordien", DevGroup:"HTML Pioneers", Attendance:5, Communication:3, Accountability:3, CreativityOwnership:3, ProjectDelivery:3, TechSkills:3},
      {Week: "Week 3", Candidate:"Ashura Noordien", DevGroup:"HTML Pioneers", Attendance:2, Communication:2, Accountability:2, CreativityOwnership:1, ProjectDelivery:2, TechSkills:2},
      {Week: "Week 4", Candidate:"Ashura Noordien", DevGroup:"HTML Pioneers", Attendance:1, Communication:1, Accountability:1, CreativityOwnership:1, ProjectDelivery:1, TechSkills:2},

      {Week: "Week 1", Candidate:"Layola Mbula", DevGroup:"HTML Pioneers", Attendance:5, Communication:4, Accountability:3, CreativityOwnership:4, ProjectDelivery:4, TechSkills:4},
      {Week: "Week 2", Candidate:"Layola Mbula", DevGroup:"HTML Pioneers", Attendance:5, Communication:5, Accountability:4, CreativityOwnership:4, ProjectDelivery:5, TechSkills:4},
      {Week: "Week 3", Candidate:"Layola Mbula", DevGroup:"HTML Pioneers", Attendance:5, Communication:5, Accountability:5, CreativityOwnership:4, ProjectDelivery:4, TechSkills:4},
      {Week: "Week 4", Candidate:"Layola Mbula", DevGroup:"HTML Pioneers", Attendance:5, Communication:5, Accountability:5, CreativityOwnership:5, ProjectDelivery:5, TechSkills:5},

      {Week: "Week 1", Candidate:"Mdumiseni Radebe", DevGroup:"HTML Pioneers", Attendance:5, Communication:3, Accountability:3, CreativityOwnership:3, ProjectDelivery:3, TechSkills:3},
      {Week: "Week 2", Candidate:"Mdumiseni Radebe", DevGroup:"HTML Pioneers", Attendance:5, Communication:4, Accountability:3, CreativityOwnership:3, ProjectDelivery:4, TechSkills:3},
      {Week: "Week 3", Candidate:"Mdumiseni Radebe", DevGroup:"HTML Pioneers", Attendance:5, Communication:4, Accountability:4, CreativityOwnership:4, ProjectDelivery:4, TechSkills:4},
      {Week: "Week 4", Candidate:"Mdumiseni Radebe", DevGroup:"HTML Pioneers", Attendance:5, Communication:5, Accountability:5, CreativityOwnership:4, ProjectDelivery:4, TechSkills:4},

      {Week: "Week 1", Candidate:"Athandile Nkcaza", DevGroup:"HTML Pioneers", Attendance:4, Communication:3, Accountability:3, CreativityOwnership:3, ProjectDelivery:3, TechSkills:4},
      {Week: "Week 2", Candidate:"Athandile Nkcaza", DevGroup:"HTML Pioneers", Attendance:4, Communication:4, Accountability:4, CreativityOwnership:4, ProjectDelivery:4, TechSkills:4},
      {Week: "Week 3", Candidate:"Athandile Nkcaza", DevGroup:"HTML Pioneers", Attendance:3, Communication:3, Accountability:4, CreativityOwnership:3, ProjectDelivery:3, TechSkills:3},
      {Week: "Week 4", Candidate:"Athandile Nkcaza", DevGroup:"HTML Pioneers", Attendance:4, Communication:4, Accountability:4, CreativityOwnership:4, ProjectDelivery:4, TechSkills:4},

      // A-GREEN CULTURE GROUP
      {Week: "Week 1", Candidate:"Amahle Ngongeni", DevGroup:"A-Green Culture", Attendance:5, Communication:3, Accountability:3, CreativityOwnership:2, ProjectDelivery:3, TechSkills:3},
      {Week: "Week 2", Candidate:"Amahle Ngongeni", DevGroup:"A-Green Culture", Attendance:5, Communication:4, Accountability:4, CreativityOwnership:3, ProjectDelivery:3, TechSkills:3},
      {Week: "Week 3", Candidate:"Amahle Ngongeni", DevGroup:"A-Green Culture", Attendance:5, Communication:4, Accountability:4, CreativityOwnership:4, ProjectDelivery:4, TechSkills:4},
      {Week: "Week 4", Candidate:"Amahle Ngongeni", DevGroup:"A-Green Culture", Attendance:5, Communication:5, Accountability:5, CreativityOwnership:4, ProjectDelivery:4, TechSkills:4},

      {Week: "Week 1", Candidate:"Inganathi Mpahleni", DevGroup:"A-Green Culture", Attendance:4, Communication:3, Accountability:3, CreativityOwnership:3, ProjectDelivery:2, TechSkills:3},
      {Week: "Week 2", Candidate:"Inganathi Mpahleni", DevGroup:"A-Green Culture", Attendance:5, Communication:4, Accountability:4, CreativityOwnership:3, ProjectDelivery:3, TechSkills:3},
      {Week: "Week 3", Candidate:"Inganathi Mpahleni", DevGroup:"A-Green Culture", Attendance:5, Communication:4, Accountability:3, CreativityOwnership:3, ProjectDelivery:3, TechSkills:3},
      {Week: "Week 4", Candidate:"Inganathi Mpahleni", DevGroup:"A-Green Culture", Attendance:5, Communication:4, Accountability:4, CreativityOwnership:4, ProjectDelivery:3, TechSkills:3},

      {Week: "Week 1", Candidate:"Mika'eel Albertyn", DevGroup:"A-Green Culture", Attendance:5, Communication:3, Accountability:4, CreativityOwnership:4, ProjectDelivery:4, TechSkills:4},
      {Week: "Week 2", Candidate:"Mika'eel Albertyn", DevGroup:"A-Green Culture", Attendance:5, Communication:5, Accountability:5, CreativityOwnership:5, ProjectDelivery:5, TechSkills:4},
      {Week: "Week 3", Candidate:"Mika'eel Albertyn", DevGroup:"A-Green Culture", Attendance:5, Communication:5, Accountability:5, CreativityOwnership:5, ProjectDelivery:5, TechSkills:5},
      {Week: "Week 4", Candidate:"Mika'eel Albertyn", DevGroup:"A-Green Culture", Attendance:5, Communication:5, Accountability:5, CreativityOwnership:5, ProjectDelivery:5, TechSkills:5},

      {Week: "Week 1", Candidate:"Naelin Churches", DevGroup:"A-Green Culture", Attendance:5, Communication:3, Accountability:4, CreativityOwnership:4, ProjectDelivery:4, TechSkills:4},
      {Week: "Week 2", Candidate:"Naelin Churches", DevGroup:"A-Green Culture", Attendance:5, Communication:4, Accountability:3, CreativityOwnership:4, ProjectDelivery:2, TechSkills:4},
      {Week: "Week 3", Candidate:"Naelin Churches", DevGroup:"A-Green Culture", Attendance:5, Communication:5, Accountability:5, CreativityOwnership:5, ProjectDelivery:4, TechSkills:4},
      {Week: "Week 4", Candidate:"Naelin Churches", DevGroup:"A-Green Culture", Attendance:5, Communication:5, Accountability:4, CreativityOwnership:4, ProjectDelivery:5, TechSkills:4},

      {Week: "Week 1", Candidate:"Phola Mavumengwana", DevGroup:"A-Green Culture", Attendance:4, Communication:3, Accountability:3, CreativityOwnership:3, ProjectDelivery:3, TechSkills:3},
      {Week: "Week 2", Candidate:"Phola Mavumengwana", DevGroup:"A-Green Culture", Attendance:5, Communication:4, Accountability:4, CreativityOwnership:4, ProjectDelivery:4, TechSkills:3},
      {Week: "Week 3", Candidate:"Phola Mavumengwana", DevGroup:"A-Green Culture", Attendance:5, Communication:4, Accountability:4, CreativityOwnership:4, ProjectDelivery:3, TechSkills:3},
      {Week: "Week 4", Candidate:"Phola Mavumengwana", DevGroup:"A-Green Culture", Attendance:5, Communication:4, Accountability:4, CreativityOwnership:4, ProjectDelivery:4, TechSkills:4}
    ];

    // --- CORE LOGIC ---

    // Hydrate data with missing metrics
    function hydrateData() {
        ALL_DATA.forEach(d => {
            d.ProblemSolving = d.TechSkills; // Assumed correlation
            d.Teamwork = d.Communication;    // Assumed correlation
            d.CodeQuality = d.TechSkills;    // Assumed correlation
            d.Leadership = d.Accountability; // Assumed correlation
            d.isFlagged = false;
            
            // Set Pipeline Stage based on Score
            if(d.Week === 'Week 4') {
                if(d.OverallScore > 80) d.PipelineStage = 'Interview Ready';
                else if(d.OverallScore < 60) d.PipelineStage = 'Needs Support';
                else d.PipelineStage = 'Training';
            } else {
                d.PipelineStage = 'Training';
            }
        });
        recalculateScores();
    }

    function recalculateScores() {
        const totalWeight = Object.values(scoringWeights).reduce((a,b)=>a+b, 0);
        const maxScorePerItem = 5;
        
        ALL_DATA.forEach(d => {
            const weightedSum = 
               (d.Attendance * scoringWeights.Attendance) +
               (d.TechSkills * scoringWeights.TechSkills) +
               (d.Communication * scoringWeights.Communication) +
               (d.Accountability * scoringWeights.Accountability) +
               (d.CreativityOwnership * scoringWeights.CreativityOwnership) +
               (d.ProjectDelivery * scoringWeights.ProjectDelivery) +
               (d.ProblemSolving * scoringWeights.ProblemSolving) +
               (d.Teamwork * scoringWeights.Teamwork) +
               (d.CodeQuality * scoringWeights.CodeQuality) +
               (d.Leadership * scoringWeights.Leadership);
            
            const maxPossible = totalWeight * maxScorePerItem;
            d.OverallScore = parseFloat(((weightedSum / maxPossible) * 100).toFixed(1));
        });
    }

    function getCategory(score) {
        if(score >= 80) return 'Excellent';
        if(score >= 60) return 'Moderate';
        return 'At-risk';
    }

    // --- APP STATE ---
    let currentState = {
        group: ['All'],
        week: 'Week 4',
        statuses: ['Excellent', 'Moderate', 'At-risk'],
        search: '',
        minScore: 0,
        liveMode: false
    };

    // --- VOICE CONTROL ---
    let voiceRecognition = null;
    function toggleVoiceControl() {
        if (!('webkitSpeechRecognition' in window)) {
            showAlert('Voice Unavailable', 'Voice recognition not supported in this browser');
            return;
        }
        
        const voiceStatus = document.getElementById('voiceStatus');
        
        if (voiceRecognition && voiceRecognition.isListening) {
            voiceRecognition.stop();
            voiceStatus.classList.add('hidden');
        } else {
            voiceRecognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            voiceRecognition.continuous = true;
            voiceRecognition.interimResults = true;
            
            voiceRecognition.onstart = () => {
                voiceStatus.classList.remove('hidden');
                voiceRecognition.isListening = true;
            };
            
            voiceRecognition.onresult = (event) => {
                const transcript = Array.from(event.results)
                    .map(result => result[0].transcript)
                    .join('');
                
                if (event.results[0].isFinal) {
                    processVoiceCommand(transcript);
                }
            };
            
            voiceRecognition.onend = () => {
                voiceStatus.classList.add('hidden');
                voiceRecognition.isListening = false;
            };
            
            voiceRecognition.start();
        }
    }

    function processVoiceCommand(command) {
        const cmd = command.toLowerCase();
        
        // Navigation commands
        if (cmd.includes('overview')) switchTab('overview', document.querySelector('.tab'));
        if (cmd.includes('kanban') || cmd.includes('pipeline')) switchTab('kanban', document.querySelectorAll('.tab')[1]);
        if (cmd.includes('analytics') || cmd.includes('deep dive')) switchTab('analytics', document.querySelectorAll('.tab')[2]);
        if (cmd.includes('candidates')) switchTab('candidates', document.querySelectorAll('.tab')[3]);
        
        // Data commands
        if (cmd.includes('reset') || cmd.includes('clear')) resetDashboard();
        if (cmd.includes('export') || cmd.includes('download')) openExportModal();
        if (cmd.includes('dark mode') || cmd.includes('light mode')) document.getElementById('darkModeToggle').click();
        
        // Search commands
        const searchMatch = cmd.match(/search (for )?(.+)/);
        if (searchMatch) {
            const searchTerm = searchMatch[2];
            document.getElementById('searchIn').value = searchTerm;
            currentState.search = searchTerm.toLowerCase();
            updateDashboard();
        }
        
        // Show confirmation
        showAlert('Voice Command', `Executed: ${command}`);
    }

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        hydrateData();
        
        // Populate Selects
        const groupSel = document.getElementById('groupSel');
        GROUPS.forEach(g => {
            const opt = document.createElement('option');
            opt.value = g; opt.text = g; groupSel.appendChild(opt);
        });
        
        const weekSel = document.getElementById('weekSel');
        WEEKS.forEach(w => {
            const opt = document.createElement('option');
            opt.value = w; opt.text = w; 
            if(w === 'Week 4') opt.selected = true;
            weekSel.appendChild(opt);
        });

        // Event Listeners
        groupSel.addEventListener('change', () => {
            const selected = Array.from(groupSel.selectedOptions).map(o => o.value);
            currentState.group = selected.includes('All') ? ['All'] : selected;
            updateDashboard();
        });

        weekSel.addEventListener('change', (e) => {
            currentState.week = e.target.value;
            updateDashboard();
        });

        document.getElementById('searchIn').addEventListener('input', debounce((e) => {
            currentState.search = e.target.value.toLowerCase();
            updateDashboard();
        }, 300));

        document.getElementById('minScore').addEventListener('input', (e) => {
            currentState.minScore = e.target.value;
            document.getElementById('scoreVal').innerText = e.target.value + '%';
            updateDashboard();
        });

        document.querySelectorAll('.status-chk').forEach(chk => {
            chk.addEventListener('change', () => {
                const checked = Array.from(document.querySelectorAll('.status-chk:checked')).map(c => c.value);
                currentState.statuses = checked;
                updateDashboard();
            });
        });

        document.getElementById('darkModeToggle').addEventListener('change', (e) => {
            document.body.setAttribute('data-theme', e.target.checked ? 'dark' : 'light');
            document.body.classList.toggle('dark-mode');
            updateDashboard();
        });

        document.getElementById('selectAll').addEventListener('change', (e) => {
            document.querySelectorAll('.row-check').forEach(c => c.checked = e.target.checked);
            checkSelection();
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'e') { e.preventDefault(); openExportModal(); }
            if (e.ctrlKey && e.key === 'f') { e.preventDefault(); document.getElementById('searchIn').focus(); }
            if (e.key === 'Escape') { document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none'); document.getElementById('aiChat').style.display = 'none'; }
        });

        // Initial Render
        feather.replace();
        setTimeout(() => {
            document.getElementById('loadingIndicator').classList.add('opacity-0');
            setTimeout(() => { 
                document.getElementById('loadingIndicator').style.display = 'none'; 
                updateDashboard();
            }, 500);
        }, 800);
    });

    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    function filterData() {
        return ALL_DATA.filter(d => {
            const matchGroup = currentState.group.includes('All') || currentState.group.includes(d.DevGroup);
            const matchWeek = currentState.week === 'All' || d.Week === currentState.week;
            const matchStatus = currentState.statuses.includes(getCategory(d.OverallScore));
            const matchSearch = d.Candidate.toLowerCase().includes(currentState.search);
            const matchScore = d.OverallScore >= currentState.minScore;
            return matchGroup && matchWeek && matchStatus && matchSearch && matchScore;
        });
    }

    function getTheme() {
        const isDark = document.body.classList.contains('dark-mode');
        return {
            text: isDark ? '#f3f2f1' : '#201f1e',
            grid: isDark ? '#484644' : '#e1dfdd',
            bg: 'transparent'
        };
    }

    function updateDashboard() {
        const filtered = filterData();
        let snapshot = filtered;
        if(currentState.week === 'All') {
             snapshot = filtered.filter(d => d.Week === 'Week 4');
        }

        const trendData = ALL_DATA.filter(d => {
             const matchGroup = currentState.group.includes('All') || currentState.group.includes(d.DevGroup);
             const matchSearch = d.Candidate.toLowerCase().includes(currentState.search);
             return matchGroup && matchSearch;
        });

        renderKPIs(snapshot);
        renderTrendChart(trendData);
        renderDistChart(snapshot);
        renderScatterChart(snapshot);
        renderRadarChart(snapshot);
        renderTable(filtered);
        renderKanbanBoard(snapshot);
        renderAnalytics(snapshot);
        renderDevelopmentPlans();
        generateInsights(snapshot);
        
        feather.replace();
    }

    function renderKPIs(data) {
        if(!data.length) { 
             ['kpiAvg','kpiRisk','kpiAtt','kpiTopName'].forEach(id => document.getElementById(id).innerText = '-');
             return; 
        }
        const avgScore = (data.reduce((a,c)=>a+c.OverallScore,0) / data.length).toFixed(1);
        const avgAtt = (data.reduce((a,c)=>a+c.Attendance,0) / data.length).toFixed(1);
        const atRisk = data.filter(d => d.OverallScore < 60).length;
        const top = data.reduce((p,c) => p.OverallScore > c.OverallScore ? p : c);

        document.getElementById('kpiAvg').innerText = avgScore + '%';
        document.getElementById('kpiAtt').innerText = avgAtt;
        document.getElementById('kpiRisk').innerText = atRisk;
        document.getElementById('kpiTopName').innerText = top.Candidate;
        document.getElementById('kpiTopScore').innerText = top.OverallScore + '%';
    }

    function renderTrendChart(data) {
        const groups = [...new Set(data.map(d => d.DevGroup))];
        const weeks = ['Week 1', 'Week 2', 'Week 3', 'Week 4'];
        const theme = getTheme();
        const colors = ['#0078d4', '#d13438', '#00cc6a', '#8764b8'];

        let traces = groups.map((g, i) => {
            const yVals = weeks.map(w => {
                const recs = data.filter(d => d.DevGroup === g && d.Week === w);
                return recs.length ? recs.reduce((a,b)=>a+b.OverallScore,0)/recs.length : null;
            });
            return {
                x: weeks, y: yVals, type: 'scatter', mode: 'lines+markers', name: g,
                line: { shape: 'spline', width: 3, color: colors[i%colors.length] },
                marker: { size: 6 }
            };
        });

        Plotly.react('trendChart', traces, {
            paper_bgcolor: 'transparent', plot_bgcolor: 'transparent',
            margin: { t: 10, r: 10, l: 40, b: 30 },
            font: { family: 'Segoe UI', color: theme.text },
            xaxis: { gridcolor: theme.grid, showgrid: false },
            yaxis: { gridcolor: theme.grid, range: [0, 105] },
            showlegend: true, legend: { orientation: 'h', y: 1.1 }
        }, {displayModeBar: false, responsive: true});
    }

    function renderDistChart(data) {
        const counts = { Excellent: 0, Moderate: 0, 'At-risk': 0 };
        data.forEach(d => counts[getCategory(d.OverallScore)]++);
        const theme = getTheme();
        Plotly.react('distChart', [{
            labels: Object.keys(counts), values: Object.values(counts),
            type: 'pie', hole: 0.6,
            marker: { colors: ['#107c10', '#ffb900', '#d13438'] },
            textinfo: 'value', hoverinfo: 'label+percent'
        }], {
            paper_bgcolor: 'transparent', plot_bgcolor: 'transparent',
            margin: { t: 0, b: 0, l: 0, r: 80 },
            showlegend: true, legend: { x: 1, y: 0.5 },
            font: { family: 'Segoe UI', color: theme.text }
        }, {displayModeBar: false, responsive: true});
    }

    function renderScatterChart(data) {
        const theme = getTheme();
        const traces = [];
        const uniqueGroups = [...new Set(data.map(d=>d.DevGroup))];
        uniqueGroups.forEach(g => {
            const gd = data.filter(d => d.DevGroup === g);
            traces.push({
                x: gd.map(d => d.TechSkills), y: gd.map(d => (d.Communication + d.Accountability + d.ProjectDelivery + d.Teamwork)/4),
                mode: 'markers', type: 'scatter', name: g, text: gd.map(d => d.Candidate),
                marker: { size: 10, opacity: 0.7 }
            });
        });
        Plotly.react('scatterChart', traces, {
            paper_bgcolor: 'transparent', plot_bgcolor: 'transparent',
            margin: { t: 20, r: 10, l: 50, b: 40 },
            xaxis: { title: 'Tech Skills', range: [0.5, 5.5], gridcolor: theme.grid },
            yaxis: { title: 'Soft Skills Avg', range: [0.5, 5.5], gridcolor: theme.grid },
            font: { family: 'Segoe UI', color: theme.text }, showlegend: false
        }, {displayModeBar: false, responsive: true});
    }

    function renderRadarChart(data) {
        if(!data.length) return;
        const theme = getTheme();
        const metrics = ['Tech', 'Comm', 'Acc', 'Proj', 'Prob', 'Team'];
        const keys = ['TechSkills', 'Communication', 'Accountability', 'ProjectDelivery', 'ProblemSolving', 'Teamwork'];
        const values = keys.map(k => data.reduce((a,b)=>a+b[k],0)/data.length);
        Plotly.react('radarChart', [{
            type: 'scatterpolar', r: [...values, values[0]], theta: [...metrics, metrics[0]],
            fill: 'toself', line: { color: '#0078d4' }, name: 'Cohort Avg'
        }], {
            polar: {
                radialaxis: { visible: true, range: [0, 5], gridcolor: theme.grid },
                angularaxis: { gridcolor: theme.grid, color: theme.text },
                bgcolor: 'transparent'
            },
            paper_bgcolor: 'transparent', margin: { t: 20, b: 20, l: 30, r: 30 },
            font: { family: 'Segoe UI', color: theme.text }, showlegend: false
        }, {displayModeBar: false, responsive: true});
    }

    function renderTable(data) {
        const tbody = document.getElementById('candidateTableBody');
        tbody.innerHTML = '';
        document.getElementById('tableCount').innerText = `${data.length} rows`;
        data.sort((a,b) => a.DevGroup.localeCompare(b.DevGroup) || a.Candidate.localeCompare(b.Candidate) || a.Week.localeCompare(b.Week));
        data.forEach(d => {
            const tr = document.createElement('tr');
            const status = getCategory(d.OverallScore);
            const badgeClass = status === 'Excellent' ? 'badge-excellent' : status === 'Moderate' ? 'badge-moderate' : 'badge-risk';
            tr.innerHTML = `
                <td><input type="checkbox" class="row-check" value="${d.Candidate}" onchange="checkSelection()"></td>
                <td class="font-semibold text-blue-600 hover:underline cursor-pointer" onclick="viewCandidate('${d.Candidate}')">${d.Candidate}</td>
                <td>${d.DevGroup}</td>
                <td class="text-xs text-gray-500 font-mono">${d.Week}</td>
                <td>${d.Attendance}/5</td>
                <td><div class="flex items-center gap-2"><div class="w-16 bg-gray-200 rounded-full h-1.5 overflow-hidden"><div class="bg-blue-500 h-1.5" style="width: ${(d.TechSkills/5)*100}%"></div></div><span class="text-xs">${d.TechSkills}</span></div></td>
                <td class="font-bold">${d.OverallScore}%</td>
                <td><span class="status-badge ${badgeClass}">${status}</span></td>
                <td><button class="text-gray-400 hover:text-blue-600" onclick="viewCandidate('${d.Candidate}')"><i data-feather="eye" class="w-4 h-4"></i></button></td>
            `;
            tbody.appendChild(tr);
        });
    }

    function renderKanbanBoard(data) {
        const stages = { 'Training': [], 'Interview Ready': [], 'Placed': [], 'Needs Support': [] };
        const uniqueData = {};
        data.forEach(d => uniqueData[d.Candidate] = d); 
        Object.values(uniqueData).forEach(d => {
            if(stages[d.PipelineStage]) stages[d.PipelineStage].push(d);
            else stages['Training'].push(d);
        });
        Object.keys(stages).forEach(key => {
            const id = 'col' + key.split(' ')[0].replace('Needs','Support');
            const cntId = 'cnt' + key.split(' ')[0].replace('Needs','Support');
            const el = document.getElementById(id);
            const cntEl = document.getElementById(cntId);
            if(el && cntEl) {
                cntEl.innerText = stages[key].length;
                el.innerHTML = stages[key].map(c => `
                    <div class="bg-white dark:bg-[#333] p-3 rounded shadow-sm border-l-4 ${c.OverallScore > 80 ? 'border-green-500' : 'border-gray-300'} cursor-grab active:cursor-grabbing" draggable="true" ondragstart="drag(event, '${c.Candidate}')">
                        <div class="font-bold text-sm mb-1">${c.Candidate}</div>
                        <div class="flex justify-between items-center text-xs text-gray-500">
                            <span>${c.DevGroup}</span>
                            <span class="font-mono bg-gray-100 dark:bg-gray-700 px-1 rounded text-black dark:text-white">${c.OverallScore}%</span>
                        </div>
                    </div>
                `).join('');
            }
        });
    }

    function allowDrop(ev) { ev.preventDefault(); }
    function drag(ev, name) { ev.dataTransfer.setData("text", name); }
    function drop(ev, newStage) {
        ev.preventDefault();
        const name = ev.dataTransfer.getData("text");
        ALL_DATA.forEach(d => { if(d.Candidate === name) d.PipelineStage = newStage; });
        updateDashboard();
        showAlert('Updated Pipeline', `${name} moved to ${newStage}`);
    }

    // --- ANALYTICS TAB: ADVANCED VISUALS ---
    function renderAnalytics(data) {
        if(document.getElementById('analyticsTab').classList.contains('hidden')) return;
        const theme = getTheme();

        // 1. Group Performance Comparison (Grouped Bar)
        const groups = [...new Set(data.map(d => d.DevGroup))];
        const groupScores = groups.map(g => {
            const recs = data.filter(d => d.DevGroup === g);
            return recs.reduce((a,b) => a+b.OverallScore, 0) / recs.length;
        });
        Plotly.react('groupPerfChart', [{
            x: groups, y: groupScores, type: 'bar', marker: {color: '#0078d4'}
        }], {
            title: 'Avg Overall Score by Group', paper_bgcolor: 'transparent', plot_bgcolor: 'transparent',
            margin: { t: 40, l: 30, r: 10, b: 30 }, font: { family: 'Segoe UI', color: theme.text },
            yaxis: {range: [0, 100]}
        }, {displayModeBar: false, responsive: true});

        // 2. Skill Profile by Performance Category (Stacked Bar)
        const cats = ['Excellent', 'Moderate', 'At-risk'];
        const skills = ['TechSkills', 'Communication', 'Accountability'];
        const traces2 = skills.map(skill => {
            return {
                x: cats,
                y: cats.map(c => {
                    const subset = data.filter(d => getCategory(d.OverallScore) === c);
                    return subset.length ? subset.reduce((a,b) => a+b[skill], 0) / subset.length : 0;
                }),
                name: skill, type: 'bar'
            };
        });
        Plotly.react('skillDistChart', traces2, {
            barmode: 'group', title: 'Avg Skill Level by Status', paper_bgcolor: 'transparent', plot_bgcolor: 'transparent',
            margin: { t: 40, l: 30, r: 10, b: 30 }, font: { family: 'Segoe UI', color: theme.text },
            legend: {orientation: 'h', y: -0.2}
        }, {displayModeBar: false, responsive: true});

        // 3. Performance Distribution by Group (Box Plot)
        const boxTraces = groups.map(g => {
            return {
                y: data.filter(d => d.DevGroup === g).map(d => d.OverallScore),
                type: 'box', name: g, boxpoints: 'all', jitter: 0.3, pointpos: -1.8
            };
        });
        Plotly.react('distBoxChart', boxTraces, {
            title: 'Score Variance Analysis', paper_bgcolor: 'transparent', plot_bgcolor: 'transparent',
            margin: { t: 40, l: 30, r: 10, b: 30 }, font: { family: 'Segoe UI', color: theme.text },
            showlegend: false
        }, {displayModeBar: false, responsive: true});

        // 4. Metric Correlation Matrix (Heatmap)
        const metrics = ['Attendance', 'TechSkills', 'Communication', 'Accountability', 'ProjectDelivery'];
        const z = [];
        metrics.forEach((m1, i) => {
            const row = [];
            metrics.forEach((m2, j) => {
                if(i === j) row.push(1);
                else {
                    const x = data.map(d => d[m1]);
                    const y = data.map(d => d[m2]);
                    const n = x.length;
                    const sumX = x.reduce((a,b)=>a+b,0);
                    const sumY = y.reduce((a,b)=>a+b,0);
                    const sumXY = x.reduce((sum, xi, k) => sum + xi * y[k], 0);
                    const sumX2 = x.reduce((sum, xi) => sum + xi*xi, 0);
                    const sumY2 = y.reduce((sum, yi) => sum + yi*yi, 0);
                    const numerator = (n * sumXY) - (sumX * sumY);
                    const denominator = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));
                    row.push(denominator === 0 ? 0 : numerator / denominator);
                }
            });
            z.push(row);
        });
        Plotly.react('corrHeatmap', [{
            z: z, x: metrics, y: metrics, type: 'heatmap', colorscale: 'RdBu', zmin: -1, zmax: 1
        }], {
            title: 'Metric Correlations', paper_bgcolor: 'transparent', plot_bgcolor: 'transparent',
            margin: { t: 40, l: 100, r: 10, b: 80 }, font: { family: 'Segoe UI', color: theme.text }
        }, {displayModeBar: false, responsive: true});

        // 5 & 6 (Existing)
        Plotly.react('peerChart', [{
            x: data.map(d => d.Attendance), y: data.map(d => d.OverallScore),
            mode: 'markers', marker: { color: data.map(d=>d.OverallScore), colorscale: 'Viridis', size: 12 },
            text: data.map(d=>d.Candidate)
        }], {
            paper_bgcolor: 'transparent', plot_bgcolor: 'transparent',
            margin: { t: 20, l: 40, r: 20, b: 40 }, font: { family: 'Segoe UI', color: theme.text },
            xaxis: { title: 'Attendance' }, yaxis: { title: 'Overall Score' }
        }, {displayModeBar: false, responsive: true});

        let zRisk = [[0,0],[0,0]];
        data.forEach(d => {
            const r = d.OverallScore >= 70 ? 0 : 1; 
            const c = d.Attendance >= 4 ? 0 : 1;
            zRisk[r][c]++;
        });
        Plotly.react('riskChart', [{
            z: zRisk, x: ['High Att', 'Low Att'], y: ['High Perf', 'Low Perf'],
            type: 'heatmap', colorscale: 'Blues', showscale: false, text: zRisk.map(r=>r.map(v=>v)), hoverinfo: 'text'
        }], {
            font: { family: 'Segoe UI', color: theme.text }, paper_bgcolor: 'transparent', margin: { t: 20, b: 20, l: 80 }
        }, {displayModeBar: false, responsive: true});
    }

    // --- AI & INSIGHTS ---
    function generateInsights(data) {
        if(!data.length) return;
        const box = document.getElementById('aiInsights');
        const avg = data.reduce((a,b)=>a+b.OverallScore,0)/data.length;
        const techAvg = data.reduce((a,b)=>a+b.TechSkills,0)/data.length;
        const commAvg = data.reduce((a,b)=>a+b.Communication,0)/data.length;
        
        let msg = `<b>Cohort Analysis:</b> Average performance is <b>${avg.toFixed(1)}%</b>. `;
        if(techAvg < commAvg) {
            msg += `The cohort demonstrates strong communication (Avg ${commAvg.toFixed(1)}) but lags in Technical Skills (Avg ${techAvg.toFixed(1)}). Recommended: Increase coding workshops.`;
        } else {
             msg += `Technical proficiency is high (Avg ${techAvg.toFixed(1)}), but soft skills require attention. Recommended: Team building exercises.`;
        }
        box.innerHTML = msg;
    }

    function renderDevelopmentPlans() {
        const container = document.getElementById('devPlansContainer');
        const week4Data = ALL_DATA.filter(d => d.Week === 'Week 4');
        
        container.innerHTML = week4Data
            .filter(d => d.OverallScore < 70)
            .map(candidate => `
                <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4 hover:shadow-md transition candidate-card">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h4 class="font-bold text-gray-800 dark:text-gray-200">${candidate.Candidate}</h4>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="text-xs px-2 py-0.5 rounded ${candidate.OverallScore < 60 ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'}">
                                    ${candidate.OverallScore}% Score
                                </span>
                                <span class="text-xs text-gray-500">${candidate.DevGroup}</span>
                            </div>
                        </div>
                        <button onclick="generateDevelopmentPlan('${candidate.Candidate}')" class="text-blue-600 hover:text-blue-800 text-sm">
                            <i data-feather="file-text" class="w-4 h-4"></i>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2 mb-3 text-xs">
                        <div class="text-gray-600 dark:text-gray-400">Tech Skills</div>
                        <div class="text-right font-semibold">${candidate.TechSkills}/5</div>
                        
                        <div class="text-gray-600 dark:text-gray-400">Attendance</div>
                        <div class="text-right font-semibold">${candidate.Attendance}/5</div>
                        
                        <div class="text-gray-600 dark:text-gray-400">Communication</div>
                        <div class="text-right font-semibold">${candidate.Communication}/5</div>
                    </div>
                    
                    <div class="text-xs text-gray-600 dark:text-gray-400">
                        ${candidate.OverallScore < 60 ? 
                            'üî¥ <b>High Priority:</b> Requires immediate intervention' : 
                            'üü° <b>Moderate Priority:</b> Needs skill development'}
                    </div>
                </div>
            `).join('');
        
        if (container.innerHTML === '') {
            container.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <i data-feather="check-circle" class="w-12 h-12 mx-auto mb-3 text-green-500"></i>
                    <p>All candidates are performing well! No active development plans needed.</p>
                </div>
            `;
        }
        
        feather.replace();
    }

    function generateDevelopmentPlan(candidateName) {
        const candidate = ALL_DATA.find(d => d.Candidate === candidateName && d.Week === 'Week 4');
        if (!candidate) return;
        
        const weaknesses = [];
        if (candidate.TechSkills < 3) weaknesses.push('Technical Skills');
        if (candidate.Attendance < 4) weaknesses.push('Attendance');
        if (candidate.Communication < 3) weaknesses.push('Communication');
        if (candidate.ProjectDelivery < 3) weaknesses.push('Project Delivery');
        
        const plan = `
            <div class="modal-overlay" onclick="this.remove()">
                <div class="modal-content">
                    <h3 class="text-lg font-bold mb-4">Development Plan: ${candidateName}</h3>
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold mb-2">Areas for Improvement:</h4>
                            <ul class="list-disc ml-5 text-sm">
                                ${weaknesses.map(w => `<li>${w}</li>`).join('')}
                            </ul>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-2">Recommended Actions:</h4>
                            <div class="text-sm space-y-2">
                                ${candidate.TechSkills < 3 ? '<p>‚Ä¢ Complete JavaScript Fundamentals course on Codecademy</p>' : ''}
                                ${candidate.Attendance < 4 ? '<p>‚Ä¢ Schedule weekly check-ins with mentor</p>' : ''}
                                ${candidate.Communication < 3 ? '<p>‚Ä¢ Join Toastmasters communication workshop</p>' : ''}
                                ${candidate.ProjectDelivery < 3 ? '<p>‚Ä¢ Practice Agile project management with mini-projects</p>' : ''}
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="printPlan('${candidateName}')" class="flex-1 bg-blue-600 text-white py-2 rounded">Print Plan</button>
                            <button onclick="this.closest('.modal-overlay').remove()" class="flex-1 bg-gray-200 dark:bg-gray-700 py-2 rounded">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', plan);
    }

    // --- AI CHATBOT LOGIC ---
    const chatHistory = document.getElementById('chatHistory');
    
    function toggleAIChat() {
        const chat = document.getElementById('aiChat');
        chat.style.display = chat.style.display === 'flex' ? 'none' : 'flex';
        if(chat.style.display === 'flex') {
            document.getElementById('chatInput').focus();
        }
    }

    function handleChatKey(e) {
        if(e.key === 'Enter') sendChat();
    }

    function sendChat() {
        const inp = document.getElementById('chatInput');
        const txt = inp.value.trim();
        if(!txt) return;
        
        appendMessage(txt, 'user');
        inp.value = '';
        
        const typingId = showTypingIndicator();

        setTimeout(() => {
            removeTypingIndicator(typingId);
            const response = generateSmartResponse(txt);
            appendMessage(response.text, 'bot');
            
            if(response.action) {
                try { response.action(); } catch(e) { console.error("Action failed:", e); }
            }
        }, 600 + Math.random() * 600);
    }

    function appendMessage(text, sender) {
        const div = document.createElement('div');
        const isUser = sender === 'user';
        div.className = `p-3 rounded-lg text-sm max-w-[85%] mb-3 shadow-sm ${isUser ? 'chat-bubble-user self-end ml-auto' : 'chat-bubble-bot self-start mr-auto'}`;
        div.innerHTML = text;
        chatHistory.appendChild(div);
        chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    function showTypingIndicator() {
        const id = 'typing-' + Date.now();
        const div = document.createElement('div');
        div.id = id;
        div.className = "chat-bubble-bot p-3 rounded-lg mb-3 self-start mr-auto w-16 flex items-center gap-1";
        div.innerHTML = `<span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></span><span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></span><span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></span>`;
        chatHistory.appendChild(div);
        chatHistory.scrollTop = chatHistory.scrollHeight;
        return id;
    }

    function removeTypingIndicator(id) {
        const el = document.getElementById(id);
        if(el) el.remove();
    }

    function generateSmartResponse(query) {
        const q = query.toLowerCase();
        let currentData = filterData();
        
        if(q.includes('reset')) {
            return { text: "I've reset all dashboard filters to their default state.", action: resetDashboard };
        }
        if(q.includes('dark') || q.includes('light') || q.includes('theme')) {
            return { text: "Toggling the display theme for you.", action: () => document.getElementById('darkModeToggle').click() };
        }
        if(q.includes('export') || q.includes('pdf') || q.includes('download')) {
            return { text: "Opening the export options...", action: openExportModal };
        }

        const foundCandidate = ALL_DATA.find(d => q.includes(d.Candidate.toLowerCase()));
        if(foundCandidate) {
            return { 
                text: `I've found <b>${foundCandidate.Candidate}</b>. They are in the ${foundCandidate.DevGroup} group. Opening their detailed profile now.`, 
                action: () => viewCandidate(foundCandidate.Candidate) 
            };
        }

        if(q.includes('top') || q.includes('best') || q.includes('highest')) {
            const sorted = [...currentData].sort((a,b) => b.OverallScore - a.OverallScore);
            const top3 = sorted.slice(0,3);
            if(!top3.length) return { text: "No data matches your current filters." };
            
            let msg = "Here are the top performers based on your current view:<br><ul class='list-disc ml-4 mt-2 space-y-1'>";
            top3.forEach(c => msg += `<li><b>${c.Candidate}</b>: ${c.OverallScore}%</li>`);
            msg += "</ul>";
            return { text: msg };
        }

        if(q.includes('risk') || q.includes('fail') || q.includes('low')) {
            const risk = currentData.filter(d => d.OverallScore < 60);
            if(risk.length === 0) return { text: "Good news! No candidates are marked 'At-Risk' in the current view." };
            return { text: `I found <b>${risk.length} candidates</b> performing below the 60% threshold. <br>Tip: Filter status to 'At Risk' to see them.` };
        }

        if(q.includes('how many') || q.includes('count')) {
            return { text: `There are currently <b>${currentData.length} records</b> visible in the dashboard.` };
        }
        
        if(q.includes('average') || q.includes('avg') || q.includes('score')) {
            const avg = (currentData.reduce((a,b)=>a+b.OverallScore,0) / currentData.length).toFixed(1);
            return { text: `The average overall score for this selection is <b>${avg}%</b>.` };
        }

        if(q.includes('group') || q.includes('team')) {
             return { text: "You can compare groups in the 'Deep Dive Analytics' tab. Would you like me to take you there?", action: () => switchTab('analytics', document.querySelectorAll('.tab')[2]) };
        }

        return { text: "I didn't quite catch that. I can help you:<br>‚Ä¢ Find a candidate (e.g., 'Show Aldo')<br>‚Ä¢ Analyze data (e.g., 'Who is top?')<br>‚Ä¢ Manage the view (e.g., 'Reset filters')" };
    }
    
    function askAI(q) {
        document.getElementById('chatInput').value = q;
        sendChat();
    }

    // --- MODALS & INTERACTIONS ---
    function viewCandidate(name) {
        const modal = document.getElementById('candidateModal');
        const personData = ALL_DATA.filter(d => d.Candidate === name);
        const latest = personData[personData.length-1];

        document.getElementById('modalName').innerText = name;
        document.getElementById('modalInitials').innerText = name.split(' ').map(n=>n[0]).join('');
        document.getElementById('modalGroup').innerText = latest.DevGroup;
        document.getElementById('modalBadge').className = 'status-badge ' + (latest.OverallScore > 80 ? 'badge-excellent' : latest.OverallScore > 60 ? 'badge-moderate' : 'badge-risk');
        document.getElementById('modalBadge').innerText = getCategory(latest.OverallScore);

        ['Score','Att','Tech','Proj'].forEach(k => {
             let key = k === 'Score' ? 'OverallScore' : k === 'Att' ? 'Attendance' : k === 'Tech' ? 'TechSkills' : 'ProjectDelivery';
             let val = latest[key];
             if(k === 'Score') val += '%';
             document.getElementById('modal'+k).innerText = val;
        });
        const soft = ((latest.Communication + latest.Accountability + latest.Teamwork)/3).toFixed(1);
        document.getElementById('modalSoft').innerText = soft;

        const recs = document.getElementById('modalRecs');
        recs.innerHTML = '';
        if(latest.Attendance < 4) recs.innerHTML += `<li class="text-red-600 font-semibold">Flagged: Low Attendance. Schedule 1:1 immediately.</li>`;
        if(latest.TechSkills < 3) recs.innerHTML += `<li>Assign "Advanced JavaScript" Learning Module.</li>`;
        if(latest.OverallScore > 85) recs.innerHTML += `<li class="text-green-600">High Potential: Consider for Team Lead role.</li>`;
        if(recs.innerHTML === '') recs.innerHTML = '<li>Maintain current learning path.</li>';

        modal.style.display = 'flex';
        
        setTimeout(() => {
            const theme = getTheme();
            Plotly.react('modalTrendChart', [{
                x: personData.map(d=>d.Week), y: personData.map(d=>d.OverallScore),
                type: 'scatter', mode: 'lines+markers', line: {color: '#0078d4', width: 3}
            }], {
                margin: {t:20,b:30,l:30,r:10}, paper_bgcolor: 'transparent', plot_bgcolor: 'transparent',
                font: {family: 'Segoe UI', color: theme.text},
                yaxis: {range: [0, 105]}
            }, {displayModeBar: false});

            const keys = ['TechSkills', 'Communication', 'Accountability', 'ProjectDelivery', 'ProblemSolving'];
            const vals = keys.map(k => latest[k]);
            Plotly.react('modalRadarChart', [{
                type: 'scatterpolar', r: [...vals, vals[0]], theta: [...keys, keys[0]],
                fill: 'toself'
            }], {
                margin: {t:20,b:20,l:40,r:40}, paper_bgcolor: 'transparent', 
                font: {family: 'Segoe UI', color: theme.text},
                polar: { radialaxis: { range: [0,5], gridcolor: theme.grid }, angularaxis: { color: theme.text } }
            }, {displayModeBar: false});
        }, 100);
    }
    
    function closeCandidateModal() { document.getElementById('candidateModal').style.display = 'none'; }

    function switchTab(id, el) {
        document.querySelectorAll('.tab-content').forEach(d => d.classList.add('hidden'));
        document.getElementById(id+'Tab').classList.remove('hidden');
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        el.classList.add('active');
        if(id === 'analytics' || id === 'kanban') {
            setTimeout(updateDashboard, 100);
        }
    }

    function checkSelection() {
        const count = document.querySelectorAll('.row-check:checked').length;
        const btn = document.getElementById('compareBtn');
        if(count > 1) { btn.classList.remove('hidden'); btn.innerText = `Compare (${count})`; }
        else btn.classList.add('hidden');
    }

    function compareCandidates() {
        switchTab('analytics', document.querySelectorAll('.tab')[2]);
        showAlert('Comparison Mode', 'Analytics filtered to selected candidates.');
    }

    function showAlert(title, msg) {
        const div = document.createElement('div');
        div.className = "bg-white dark:bg-[#333] border-l-4 border-blue-500 shadow-lg p-3 rounded text-sm mb-2 animate-fade-in";
        div.innerHTML = `<b>${title}</b><br><span class="text-gray-500">${msg}</span>`;
        document.getElementById('performanceAlerts').appendChild(div);
        setTimeout(() => div.remove(), 4000);
    }

    function resetDashboard() {
        document.getElementById('groupSel').value = 'All';
        document.getElementById('weekSel').value = 'Week 4';
        document.getElementById('searchIn').value = '';
        currentState = { group: ['All'], week: 'Week 4', statuses: ['Excellent', 'Moderate', 'At-risk'], search: '', minScore: 0, liveMode: currentState.liveMode };
        updateDashboard();
    }

    let liveInterval;
    function toggleLiveMode() {
        currentState.liveMode = !currentState.liveMode;
        const btn = document.getElementById('liveBtn');
        const dot = document.getElementById('liveDot');
        
        if(currentState.liveMode) {
            btn.classList.add('bg-red-500', 'hover:bg-red-600');
            dot.classList.add('bg-white', 'animate-ping');
            dot.classList.remove('bg-gray-400');
            
            liveInterval = setInterval(() => {
                const idx = Math.floor(Math.random() * ALL_DATA.length);
                const d = ALL_DATA[idx];
                d.OverallScore = Math.min(100, Math.max(0, d.OverallScore + (Math.random() > 0.5 ? 2 : -2)));
                updateDashboard();
            }, 1500);
        } else {
            btn.classList.remove('bg-red-500', 'hover:bg-red-600');
            dot.classList.remove('bg-white', 'animate-ping');
            dot.classList.add('bg-gray-400');
            clearInterval(liveInterval);
        }
    }

    function openExportModal() {
        const modalHTML = `
            <div class="modal-overlay" onclick="this.remove()">
                <div class="modal-content">
                    <h3 class="text-lg font-bold mb-4">Export Options</h3>
                    <div class="space-y-3">
                        <button onclick="exportFullReport()" class="w-full text-left p-3 border rounded hover:bg-gray-50 dark:hover:bg-gray-800 flex items-center justify-between">
                            <div>
                                <div class="font-semibold">Full Cohort Report</div>
                                <div class="text-xs text-gray-500">All candidates with detailed metrics</div>
                            </div>
                            <i data-feather="file-text" class="w-5 h-5 text-blue-600"></i>
                        </button>
                        
                        <button onclick="exportAtRisk()" class="w-full text-left p-3 border rounded hover:bg-gray-50 dark:hover:bg-gray-800 flex items-center justify-between">
                            <div>
                                <div class="font-semibold">At-Risk Candidates Report</div>
                                <div class="text-xs text-gray-500">Only candidates below 60%</div>
                            </div>
                            <i data-feather="alert-triangle" class="w-5 h-5 text-red-600"></i>
                        </button>
                        
                        <button onclick="exportByGroup()" class="w-full text-left p-3 border rounded hover:bg-gray-50 dark:hover:bg-gray-800 flex items-center justify-between">
                            <div>
                                <div class="font-semibold">Group Performance Report</div>
                                <div class="text-xs text-gray-500">Comparative analysis by development group</div>
                            </div>
                            <i data-feather="bar-chart-2" class="w-5 h-5 text-green-600"></i>
                        </button>
                        
                        <button onclick="exportCustom()" class="w-full text-left p-3 border rounded hover:bg-gray-50 dark:hover:bg-gray-800 flex items-center justify-between">
                            <div>
                                <div class="font-semibold">Custom Selection</div>
                                <div class="text-xs text-gray-500">Export currently filtered view</div>
                            </div>
                            <i data-feather="settings" class="w-5 h-5 text-purple-600"></i>
                        </button>
                    </div>
                    <div class="mt-6 text-xs text-gray-500">
                        Reports are generated as PDF files with detailed analytics.
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        feather.replace();
    }

    function exportFullReport() {
        const doc = new jsPDF();
        const filtered = ALL_DATA.filter(d => d.Week === 'Week 4');
        
        doc.setFontSize(18);
        doc.text("MICT SP Performance Analytics - Full Report", 20, 20);
        doc.setFontSize(11);
        doc.text(`Generated: ${new Date().toLocaleDateString()} | Total Candidates: ${filtered.length}`, 20, 30);
        
        const avgScore = (filtered.reduce((a,c)=>a+c.OverallScore,0)/filtered.length).toFixed(1);
        const atRisk = filtered.filter(d => d.OverallScore < 60).length;
        const excellent = filtered.filter(d => d.OverallScore >= 80).length;
        
        doc.setFontSize(12);
        doc.text("Summary Statistics:", 20, 45);
        doc.setFontSize(10);
        doc.text(`Average Score: ${avgScore}%`, 25, 55);
        doc.text(`At-Risk Candidates: ${atRisk}`, 25, 62);
        doc.text(`Excellent Performers: ${excellent}`, 25, 69);
        
        doc.autoTable({
            startY: 80,
            head: [['Candidate', 'Group', 'Score', 'Tech Skills', 'Attendance', 'Status']],
            body: filtered.map(d => [
                d.Candidate,
                d.DevGroup,
                `${d.OverallScore}%`,
                d.TechSkills,
                d.Attendance,
                getCategory(d.OverallScore)
            ]),
            styles: { fontSize: 9 },
            headStyles: { fillColor: [0, 120, 212] }
        });
        
        doc.save(`MICT_Full_Report_${new Date().toISOString().slice(0,10)}.pdf`);
        showAlert('Export Complete', 'Full report downloaded as PDF');
    }

    function exportCustom() {
        const filtered = filterData();
        const doc = new jsPDF();
        
        doc.setFontSize(16);
        doc.text("Custom Filtered Report", 20, 20);
        doc.setFontSize(10);
        doc.text(`Filters: ${currentState.group.join(', ')} | Week: ${currentState.week}`, 20, 30);
        
        doc.autoTable({
            startY: 40,
            head: [['Candidate', 'Group', 'Week', 'Score', 'Status']],
            body: filtered.map(d => [
                d.Candidate,
                d.DevGroup,
                d.Week,
                `${d.OverallScore}%`,
                getCategory(d.OverallScore)
            ])
        });
        
        doc.save('MICT_Filtered_View.pdf');
    }
    
    function openSettingsModal() { document.getElementById('settingsModal').style.display='flex'; }
    function saveSettings() { 
        document.getElementById('settingsModal').style.display='none'; 
        recalculateScores();
        updateDashboard();
    }

    // --- FILE UPLOAD HANDLER ---
    function handleFileUpload(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const newData = JSON.parse(e.target.result);
                    if (Array.isArray(newData)) {
                        ALL_DATA = newData;
                        hydrateData();
                        updateDashboard();
                        showAlert('Data Imported', `Successfully loaded ${newData.length} records`);
                        document.getElementById('dsName').innerText = file.name;
                    }
                } catch (error) {
                    showAlert('Import Error', 'Invalid JSON file format');
                }
            };
            reader.readAsText(file);
        }
    }

  </script>
</body>
</html>
